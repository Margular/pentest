#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import argparse
import netaddr
import os
import os.path
import re
import sys


class IPHandler:
    pool = []

    compiled_regexps = [
        re.compile(r'\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)'
                   r'(?:/(?:3[0-2]|[0-2]?[0-9]))?\b'),
    ]

    def parse_to_pool(self, text):
        for compiled_regexp in self.compiled_regexps:
            for found in compiled_regexp.findall(text):
                self.pool.append(netaddr.IPNetwork(found))

        self.pool = netaddr.cidr_merge(self.pool)

    def gen_cidrs(self):
        for cidr in self.pool:
            yield str(cidr)

    def gen_ips(self):
        for cidr in self.pool:
            for ip in cidr:
                yield str(ip)


def main():
    parser = argparse.ArgumentParser(description='give me any formats of data and extracts ip or cidr for you')

    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument('-i', help='output ips', action='store_true')
    group.add_argument('-c', help='output cidrs', action='store_true')

    parser.add_argument('file', help='intput filepath', nargs='*')
    args = parser.parse_args()

    if args.i and args.c:
        sys.stderr.write('you can not choose double types!\n')
        sys.exit(-1)

    ip_handler = IPHandler()

    if args.file:
        for filepath in args.file:
            if not os.path.isfile(filepath):
                sys.stderr.write(filepath + ' is not a valid file!\n')
                sys.exit(-1)
            for line in open(filepath):
                ip_handler.parse_to_pool(line)
    else:
        for line in sys.stdin.readlines():
            ip_handler.parse_to_pool(line)

    if args.i:
        for ip in ip_handler.gen_ips():
            sys.stdout.write(ip + '\n')
    elif args.c:
        for cidr in ip_handler.gen_cidrs():
            sys.stdout.write(cidr + '\n')
    else:
        sys.stderr.write('nothing happened!\n')
        sys.exit(-1)


if __name__ == '__main__':
    main()
