#!/usr/bin/env python
# -*- coding: utf-8 -*-

import json
import pprint
from jsonmerge import Merger

class Parser:

    AMASS = 'amass.json'
    DOMAINS = ['sublist3r.txt']
    SUBDOMAINSBRUTE = 'subDomainsBrute.txt'
    IPS = ['ip.txt']

    SCHEMA = {"properties":{"addresses":{"mergeStrategy":"append"}}}

    data = []

    def __init__(self):
        self.extendAmass()

        for domain in self.DOMAINS:
            self.extendDomains(domain)

        for entry2 in self.subDomainsBrute():
            duplicate = False
            for i, entry in enumerate(self.data):
                if entry['name'] == entry2['name']:
                    duplicate = True
                    merger = Merger(self.SCHEMA)
                    self.data[i] = merger.merge(entry, entry2)
            if not duplicate:
                self.data.append(entry2)

        for _ in self.IPS:
            for entry2 in self.ip(_):
                duplicate = False
                for i, entry in enumerate(self.data):
                    if 'addresses' in entry.keys():
                        for address in entry['addresses']:
                            if address['ip'] == entry2['addresses'][0]['ip']:
                                duplicate = True
                                break

                    if duplicate:
                        break

                if not duplicate:
                    self.data.append(entry2)

    def extendAmass(self):
        return self.data.extend(self.parseJsons(self.AMASS))

    def extendDomains(self, filename):
        for domain in open(filename).read().strip().split('\n'):
            duplicate = False
            domain = domain.split(':')[0]
            for entry in self.data:
                if domain == entry['name']:
                    duplicate = True
                    break
            if not duplicate:
                self.data.append({'name' : domain})

    def parseJsons(self, filename):
        content = open(filename).read().strip().split('\n')
        content = '[' + ','.join(content) + ']'
        return json.loads(content)


    def subDomainsBrute(self):
        for line in open(self.SUBDOMAINSBRUTE).read().strip().split('\n'):
            _ = line.split()
            data = {'name' : _[0],
                    'addresses' : list(map(
                        lambda _ : {'ip' : _.split(',')[0]},
                        _[1:]
                    ))}
            yield data

    def ip(self, filename):
        for _ in open(filename).read().strip().split('\n'):
            data = {'addresses' : [{'ip' : _}]}
            yield data

if __name__ == '__main__':
    parser = Parser()
    for entry in parser.data:
        if 'addresses' in entry.keys():
            for address in entry['addresses']:
                #print(address['ip'])
                pass

    #pprint.pprint(parser.data)
    for entry in parser.data:
        print(entry)
