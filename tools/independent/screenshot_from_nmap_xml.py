#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os.path

from libnmap.parser import NmapParser
from libnmap.process import NmapProcess
from time import sleep
from selenium import webdriver
from selenium.common.exceptions import TimeoutException

def get_screenshot(authority):
    print('take screenshots of ' + authority)
    # get http without ssl screenshot
    if open_port != 443:
        screenshot_path = os.path.join('screenshots', authority.replace(':','.') + '.http.png')
        if not os.path.exists(screenshot_path):
            try:
                driver.get('http://' + authority + '/')
                driver.save_screenshot(screenshot_path)
            except TimeoutException:
                pass
        
    # get https screenshot
    if open_ports != 80:
        screenshot_path = os.path.join('screenshots', authority.replace(':','.') + '.https.png')
        if not os.path.exists(screenshot_path):
            try:
                driver.get('https://' + authority + '/')
                driver.save_screenshot(screenshot_path)
            except TimeoutException:
                pass

# check directory
if not os.path.isdir('screenshots'):
    os.mkdir('screenshots')

# init chromedriver
DRIVER = 'chromedriver'
driver = webdriver.Chrome(DRIVER)
driver.set_page_load_timeout(20)

# get data from nmap xml file
nmap_report = NmapParser.parse_fromfile('result.xml')
print('parsing from result.xml...')
hosts = nmap_report.hosts
print('hosts loaded.')
for host in hosts:
    open_ports_tuple = host.get_open_ports()
    open_ports = [ t[0] for t in open_ports_tuple ]
    # filter hosts without any open ports
    if open_ports == []:
        continue

    for open_port in open_ports:
        authority = host.address + ':' + str(open_port)
        get_screenshot(authority)

# quit chromedriver
driver.quit()
