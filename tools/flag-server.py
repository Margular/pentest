#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import argparse
import multiprocessing as mp
import redis
import requests
import socket
import time
import threading

from http.server import BaseHTTPRequestHandler, HTTPServer
from urllib.parse import parse_qs

"""server.py: Flag server used to submit flag to competition server"""

__author__ = "Margular"
__copyright__ = "Copyright 2018, Margular"
__version__ = "1.0.0"


def PopFlag():
    r = redis.Redis(host='localhost', port=6379, decode_responses=True)
    return r.lpop('flags')


def PushFlag(flag):
    r = redis.Redis(host='localhost', port=6379, decode_responses=True)
    return r.rpush('flags', flag)


def GetFlags():
    r = redis.Redis(host='localhost', port=6379, decode_responses=True)
    return r.lrange('flags', 0, -1)


def AWDHTTPServer(hostname, httpport):
    httpd = HTTPServer((hostname, httpport), AWDHTTPHandler)
    print(time.asctime(), "Server Starts - {}:{}".format(hostname, httpport))
    try:
        while True:
            httpd.serve_forever()
    except KeyboardInterrupt:
        pass


class AWDHTTPHandler(BaseHTTPRequestHandler):
    server_version = 'nginx'
    sys_version = '0.6.36'

    def do_GET(self):
        print('\n\nget\n\n')
        self.send_response(200)
        self.send_header("Content-type", "text/html")
        self.end_headers()
        params = parse_qs(self.path[2:])
        if 'flag' in params.keys():
            PushFlag(params['flag'][0])
            Logger()
            self.wfile.write(bytes('OK', 'utf-8'))

    def do_POST(self):
        print('\n\npost\n\n')
        self.send_response(200)
        self.send_header("Content-type", "text/html")
        self.end_headers()
        content_len = self.headers.get('content-length')
        if content_len is None:
            return
        content_len = int(content_len, 0)
        if content_len < 5:
            return
        flag = self.rfile.read(content_len).decode('utf-8')
        PushFlag(flag)
        Logger()


def HandleTcp(sock, addr):
    print("Accept new connection from {}:{}...".format(addr[0], addr[1]))
    try:
        while True:
            data = sock.recv(1024)
            time.sleep(1)
            if not data:
                break
            flag = data.decode('utf-8', errors='backslashesreplace')
            flag = flag.strip()
            print("Accept new flag {} from {}:{}".format(
                flag, addr[0], addr[1]))
            PushFlag(flag)
            Logger()
    except:
        pass
    sock.close()
    print("Connection from {}:{} closed.".format(addr[0], addr[1]))


def ListenTcp(listen, port):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.bind((listen, port))
    s.listen(20)
    print('Waiting for tcp connection on {}:{}...'.format(listen, port))
    try:
        while True:
            sock, addr = s.accept()
            t = threading.Thread(target=HandleTcp, args=(sock, addr))
            t.start()
    except KeyboardInterrupt:
        pass


def SubmitFlag(flag):
    r = requests.get('http://www.baidu.com', auth=('user', 'pass'))
    r = requests.post('http://www.baidu.com', data={'flag': 'test'})
    # print(r.text)
    # r.json()
    return False


def Logger():
    output = "flags: ["
    for flag in GetFlags():
        output += flag
        output += ', '
    output += ']'
    print(output)

    output = "pool: ["
    for process in pool:
        output += process.name
        output += ', '
    output += ']'
    print(output)


def IntervalLogger():
    try:
        while True:
            Logger()
            time.sleep(60)
    except KeyboardInterrupt:
        pass


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Flag Server')
    parser.add_argument(
        '-l', '--listen', help='ip to listen, default is 0.0.0.0', default='0.0.0.0')
    parser.add_argument(
        '-p', '--port', help='port to listen, default is 8100', default=8100, type=int)
    parser.add_argument(
        '-w', '--wait', help='ms to wait between flag submit interval, default is 100ms, and wait time need bigger than 100ms', type=float, default=100)
    parser.add_argument(
        '-n', '--hostname', help='http server listen, default is 0.0.0.0', default='0.0.0.0')
    parser.add_argument(
        '-t', '--httpport', help='http server port, default is 8200', default=8200, type=int)
    args = parser.parse_args()

    pool = []
    pool.append(mp.Process(target=IntervalLogger, name='Logger'))
    pool.append(mp.Process(target=ListenTcp,
                           args=(args.listen, args.port), name='Listener'))
    pool.append(mp.Process(target=AWDHTTPServer,
                           args=(args.hostname, args.httpport), name='AWDHTTPServer'))

    for _ in pool:
        _.start()

    # init wait time
    wait = args.wait / 1000 if args.wait > 100 else 0.1

    try:
        while True:
            flag = PopFlag()
            if flag:
                # submit flag
                print('submit flag: ' + flag)
                if not SubmitFlag(flag):
                    # failed to submit flag
                    PushFlag(flag)
                    print('failed to submit flag: ' + flag)
                else:
                    print('successed to submit flag: ' + flag)
            time.sleep(wait)
    except KeyboardInterrupt:
        print('Exit Flag Server!')
